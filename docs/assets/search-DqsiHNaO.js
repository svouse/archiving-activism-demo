const k={precursors:[1940,1959],thick:[1960,1989],today:[1990,2100]},y="/";function p(s){if(typeof s=="number"&&Number.isFinite(s))return s;if(typeof s=="string"){const t=parseInt(s,10);return Number.isFinite(t)?t:null}return null}function w(s){return(s.split("/").pop()||s).replace(/\.[a-z0-9]+$/i,"").split("_").slice(3).join(" ").replace(/[-]+/g," ").replace(/\s+/g," ").trim()}function S(s,t,e){const n=[],a=o=>{o&&(Array.isArray(o)?o.forEach(l=>typeof l=="string"&&n.push(l)):typeof o=="string"&&o.split(/[;,]/).forEach(l=>n.push(l)))};return a(s),a(t),n.length===0&&a(e),n.map(o=>o.trim()).filter(o=>o.length>0).filter(o=>o.length<=40&&o.split(/\s+/).length<=5).reduce((o,l)=>{const f=l.toLowerCase();return o.some(h=>h.toLowerCase()===f)||o.push(l),o},[])}let C=[],E={},g=[],u="";const d=new Set;let L=[],c=null;const r={q:null,clear:null,tagList:null,meta:null,results:null,sort:null,eraChips:null};async function R(){if(r.q=document.getElementById("q"),r.clear=document.getElementById("clear"),r.tagList=document.getElementById("tagList"),r.meta=document.getElementById("meta"),r.results=document.getElementById("results"),r.sort=document.getElementById("sort"),r.eraChips=document.getElementById("eraChips"),!r.results||!r.q||!r.sort||!r.tagList){console.warn("[search] Missing required DOM (#results, #q, #sort, #tagList). Check search.html IDs.");return}const{cloud:s,byId:t}=await v();C=s,E=t,g=I(C,E),L=q(g),D(L),A(),x(),T(),m()}async function v(){const[s,t]=await Promise.all([fetch(y+"data/cloud.resources.json").then(e=>e.json()),fetch(y+"data/resources.byId.json").then(e=>e.json())]);return{cloud:s,byId:t}}function I(s,t){return s.map(e=>{const n=t[String(e.id)],a=e.documentDirect||(n==null?void 0:n.url)||e.link||null,i=(n==null?void 0:n.title)||e.title||"Untitled",o=/_/.test(i)?w(i):i,l=S(n==null?void 0:n.tags,e.tags,n==null?void 0:n.topics);return{id:e.id,title:o,rawTitle:i,year:p(e.year)??p(n==null?void 0:n.year)??null,url:a,tags:l,repo:(n==null?void 0:n.repository)??e.repository??null,iconURL:e.previewLocal,description:(n==null?void 0:n.description)??e.description??null}})}function q(s){const t=new Set;return s.forEach(e=>(e.tags||[]).forEach(n=>t.add(String(n)))),Array.from(t).sort((e,n)=>e.localeCompare(n))}function T(){r.q.addEventListener("input",()=>{u=r.q.value,m()}),r.clear&&r.clear.addEventListener("click",()=>{u="",r.q.value="",m()}),r.sort.addEventListener("change",m)}function x(){const s=new URLSearchParams(location.search),t=s.get("q");t&&(u=t,r.q.value=t),(s.get("tags")||"").split(",").filter(Boolean).forEach(i=>d.add(i));const n=s.get("sort");n&&["relevance","year-desc","year-asc","title-asc"].includes(n)&&(r.sort.value=n);const a=s.get("era");a&&k[a]&&(c=a)}function B(s){if(!r.meta)return;const t=new URLSearchParams;u&&t.set("q",u),d.size&&t.set("tags",Array.from(d).join(",")),c&&t.set("era",c),t.set("sort",r.sort.value),history.replaceState({},"",`${location.pathname}?${t}`),r.meta.textContent=`${s.length} result${s.length===1?"":"s"}`}function D(s){r.tagList.innerHTML="",s.forEach(t=>{const e=`tag-${t.replace(/\W+/g,"-")}`,n=document.createElement("label"),a=document.createElement("input");a.type="checkbox",a.id=e,a.value=t,a.checked=d.has(t),a.addEventListener("change",()=>{a.checked?d.add(t):d.delete(t),m()});const i=document.createElement("span");i.textContent=t,n.appendChild(a),n.appendChild(i),r.tagList.appendChild(n)})}function A(){if(!r.eraChips)return;r.eraChips.innerHTML="",[{key:"precursors",title:"Precursors",sub:"1940s–1950s"},{key:"thick",title:"In the Thick of the Struggle",sub:"1960s–1980s"},{key:"today",title:"Student Organizing Today",sub:"1990s–present"}].forEach(t=>{const e=document.createElement("button");e.type="button",e.className="chip",c===t.key&&e.classList.add("is-active"),e.setAttribute("data-era",t.key),e.innerHTML=`<span>${t.title}</span><span class="sub">${t.sub}</span>`,e.addEventListener("click",()=>{c=c===t.key?null:t.key,Array.from(r.eraChips.querySelectorAll(".chip")).forEach(n=>n.classList.remove("is-active")),c&&e.classList.add("is-active"),m()}),r.eraChips.appendChild(e)})}function N(s,t){if(!t.trim())return!0;const e=[(s.title||"").toLowerCase(),(s.description||"").toLowerCase(),...(s.tags||[]).map(a=>String(a).toLowerCase())];return t.toLowerCase().split(/\s+/).filter(Boolean).every(a=>e.some(i=>i.includes(a)))}function U(s){if(!d.size)return!0;const t=new Set((s.tags||[]).map(e=>String(e).toLowerCase()));for(const e of d)if(!t.has(String(e).toLowerCase()))return!1;return!0}function $(s){if(!c)return!0;const[t,e]=k[c],n=p(s.year);return n!==null&&n>=t&&n<=e}function b(s,t){if(!t.trim())return 0;const e=t.toLowerCase();let n=0;const a=(s.title||"").toLowerCase(),i=(s.description||"").toLowerCase();return a.includes(e)&&(n+=5),i.includes(e)&&(n+=2),(s.tags||[]).forEach(o=>{String(o).toLowerCase().includes(e)&&(n+=1)}),n}function m(){const s=g.filter(e=>N(e,u)&&U(e)&&$(e)),t=r.sort.value;s.sort((e,n)=>t==="year-desc"?(p(n.year)??-1)-(p(e.year)??-1):t==="year-asc"?(p(e.year)??1)-(p(n.year)??1):t==="title-asc"?(e.title||"").localeCompare(n.title||""):b(n,u)-b(e,u)),B(s),P(s)}function P(s){r.results.innerHTML="",s.forEach(t=>{const e=document.createElement("article");e.className="card";const n=document.createElement("h4");n.textContent=t.title||"Untitled";const a=document.createElement("div");a.className="year",a.textContent=t.year!=null?String(t.year):"—";const i=document.createElement("img");i.className="thumb",i.alt=t.title||"thumbnail",i.src=t.iconURL;const o=document.createElement("div");(t.tags||[]).slice(0,10).forEach(f=>{const h=document.createElement("span");h.className="pill",h.textContent=String(f),o.appendChild(h)});const l=document.createElement("a");l.href=t.url||"#",l.target="_blank",l.rel="noopener",l.textContent=t.url?"Open document":"No link available",e.appendChild(n),e.appendChild(a),e.appendChild(i),e.appendChild(o),e.appendChild(l),r.results.appendChild(e)})}export{R as initSearch};
